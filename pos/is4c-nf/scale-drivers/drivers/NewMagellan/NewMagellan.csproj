<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" 
    DefaultTarget="Build" ToolsVersion="4.0">

  <!-- global properties for project -->
  <PropertyGroup>
    <!--
      Wrapped ActiveX control is 32-bit only. Change platform
      and disable warnings if using x64 csc.exe
    -->
    <BuildPlatform Condition=" Exists('DSIPDCXLib.dll') And Exists('AxDSIPDCXLib.dll') ">x86</BuildPlatform>
    <BuildPlatform Condition=" !Exists('DSIPDCXLib.dll') Or !Exists('AxDSIPDCXLib.dll') ">anycpu</BuildPlatform>
    <NoWarn Condition=" Exists('DSIPDCXLib.dll') And Exists('AxDSIPDCXLib.dll') ">1607</NoWarn>
  </PropertyGroup>

  <!-- Defined constants -->
  <ItemGroup>
    <MonoDefine Include="MONO" Condition=" '$(OS)' == 'Unix' " />

    <FutureDefine Include="FUTURE" />
    <FutureDefine Include="FUTUREWIN" Condition=" '$(OS)' != 'Unix' " />
  </ItemGroup>

  <!--
    Build the main application
    Default target "Build" produces pos.exe
    Alt target "Future" produces pos-future.exe
  -->
  <ItemGroup>
    <Magellan Include="Magellan.cs" />

    <MagellanRef Include="DelegateForm.dll" />
    <MagellanRef Include="UDPMsgBox.dll" />
    <MagellanRef Include="SPH.dll" />
    <MagellanRef Include="rabbitmq\RabbitMQ.Client.dll" Condition=" Exists('rabbimq\RabbitMQ.Client.dll') " />

    <MagellanTarget Include="DelegateFormLibrary" />
    <MagellanTarget Include="UDPMsgBoxLibrary" />
    <MagellanTarget Include="SPHLibrary" />

    <MagellanFutureRef Include="DelegateForm.dll" />
    <MagellanFutureRef Include="UDPMsgBox.dll" />
    <MagellanFutureRef Include="SPHFuture.dll" />

    <MagellanFutureTarget Include="DelegateFormLibrary" />
    <MagellanFutureTarget Include="UDPMsgBoxLibrary" />
    <MagellanFutureTarget Include="SPHFutureLibrary" />
  </ItemGroup>
  <Target Name="Build" DependsOnTargets="@(MagellanTarget)">
    <Csc Sources="@(Magellan)" References="@(MagellanRef)" TargetType="exe" OutputAssembly="pos.exe" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>
  <Target Name="Future" DependsOnTargets="@(MagellanFutureTarget)">
    <Csc Sources="@(Magellan)" References="@(MagellanFutureRef)" TargetType="exe" OutputAssembly="pos-future.exe" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

  <!-- Build DelegateForm.dll -->
  <ItemGroup>
    <DelegateForm Include="DelegateForm.cs" />
  </ItemGroup>
  <Target Name="DelegateFormLibrary" Returns="DelegateForm.dll">
    <Csc Sources="@(DelegateForm)" TargetType="library" OutputAssembly="DelegateForm.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

  <!-- Build Bitmap.dll -->
  <ItemGroup>
    <Bitmap Include="BitmapConverter.cs" />
  </ItemGroup>
  <Target Name="BitmapLibrary" Returns="Bitmap.dll">
    <Csc Sources="@(Bitmap)" TargetType="library" OutputAssembly="Bitmap.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

  <!-- Build ParallelLayer.dll -->
  <ItemGroup>
    <ParallelLayer Include="ParallelLayer.cs" />
    <!-- low-level details are OS-specific -->
    <ParallelLayer Include="Parallel-Win32.cs" Condition=" '$(OS)' != 'Unix' " />
    <ParallelLayer Include="Parallel-Posix.cs" Condition=" '$(OS)' == 'Unix' " />
  </ItemGroup>
  <Target Name="ParallelLayerLibrary" Returns="ParallelLayer.dll">
    <Csc Sources="@(ParallelLayer)" TargetType="library" OutputAssembly="ParallelLayer.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

  <!-- Build USBLayer.dll -->
  <ItemGroup>
    <USBLayer Include="USBLayer.cs" />
    <!-- use one of the OS-dependent options plus the HidSharp library -->
    <USBLayer Include="USB-Win32.cs" Condition=" '$(OS)' != 'Unix' " />
    <USBLayer Include="USB-Posix.cs" Condition=" '$(OS)' == 'Unix' " />
    <USBLayer Include="USB-HidSharp.cs" />
    
    <USBLayerRef Include="HIDSharp.dll" />

    <USBLayerTarget Include="HIDSharpLibrary" />
  </ItemGroup>
  <Target Name="USBLayerLibrary" Returns="USBLayer.dll" DependsOnTargets="@(USBLayerTarget)">
    <Csc Sources="@(USBLayer)" TargetType="library" References="@(USBLayerRef)" OutputAssembly="USBLayer.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

  <!-- Build USBMsgBox.dll -->
  <ItemGroup>
    <UDPMsgBox Include="UDPMsgBox.cs" />

    <UDPMsgBoxRef Include="DelegateForm.dll" />
  </ItemGroup>
  <Target Name="UDPMsgBoxLibrary" Returns="UDPMsgBox.dll" DependsOnTargets="DelegateFormLibrary">
    <Csc Sources="@(UDPMsgBox)" References="@(UDPMsgBoxRef)" TargetType="library" OutputAssembly="UDPMsgBox.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

  <!--
    Build SPH.dll and/or SPHFuture.dll
    The files are all the same. The "Future" version just
    defines a couple constants for #if macros
  -->
  <ItemGroup>
    <SPH Include="SerialPortHandler.cs" />
    <SPH Include="SPH_Magellan_Scale.cs" />
    <SPH Include="SPH_SignAndPay_USB.cs" />
    <SPH Include="SPH_IngenicoRBA_Common.cs" />
    <SPH Include="SPH_IngenicoRBA_RS232.cs" />
    <SPH Include="SPH_IngenicoRBA_IP.cs" />
    <SPH Include="SPH_IngenicoRBA_USB.cs" />
    <SPH Include="SPH_Parallel_Writer.cs" />
    <SPH Include="SPH_Datacap_PDCX.cs" Condition=" Exists('DSIPDCXLib.dll') And Exists('AxDSIPDCXLib.dll') " />

    <SPHRef Include="DelegateForm.dll" />
    <SPHRef Include="Bitmap.dll" />
    <SPHRef Include="USBLayer.dll" />
    <SPHRef Include="ParallelLayer.dll" />
    <SPHRef Include="DSIPDCXLib.dll" Condition=" Exists('DSIPDCXLib.dll') And Exists('AxDSIPDCXLib.dll') " />
    <SPHRef Include="AxDSIPDCXLib.dll" Condition=" Exists('DSIPDCXLib.dll') And Exists('AxDSIPDCXLib.dll') " />

    <SPHTarget Include="DelegateFormLibrary" />
    <SPHTarget Include="BitmapLibrary" />
    <SPHTarget Include="USBLayerLibrary" />
    <SPHTarget Include="ParallelLayerLibrary" />
  </ItemGroup>
  <Target Name="SPHLibrary" Returns="SPH.dll" DependsOnTargets="@(SPHTarget)">
    <Csc Sources="@(SPH)" DefineConstants="@(MonoDefine)" References="@(SPHRef)" TargetType="library" OutputAssembly="SPH.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>
  <Target Name="SPHFutureLibrary" Returns="SPHFuture.dll" DependsOnTargets="@(SPHTarget)">
    <Csc Sources="@(SPH)" DefineConstants="@(MonoDefine);@(FutureDefine)" References="@(SPHRef)" TargetType="library" OutputAssembly="SPHFuture.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

  <!-- 
    Build HidSharp project as HIDSharp.dll
    Probably a better way of doing this utilizing
    the .vcsproj file in the HidSharp directory
  -->
  <ItemGroup>
    <HidSharp Include="HidSharp\ReportDescriptors\GlobalItemTag.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\CollectionType.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\ItemType.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\MainItemTag.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\LocalItemTag.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\ReportSegment.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\ReportType.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\LocalIndexes.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\ReportMainItem.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\IndexList.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\Report.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\IndexBase.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\ReportDescriptorParser.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\IndexRange.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Parser\ReportCollection.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\EncodedItem.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\TimeUnit.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\Unit.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\UnitSystem.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\TemperatureUnit.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\LuminousIntensityUnit.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\CurrentUnit.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\MassUnit.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\Units\LengthUnit.cs" /> 
    <HidSharp Include="HidSharp\ReportDescriptors\DataMainItemFlags.cs" /> 
    <HidSharp Include="HidSharp\HidDevice.cs" /> 
    <HidSharp Include="HidSharp\Throw.cs" /> 
    <HidSharp Include="HidSharp\AsyncResult.cs" /> 
    <HidSharp Include="HidSharp\Properties\AssemblyInfo.cs" /> 
    <HidSharp Include="HidSharp\HidStream.cs" /> 
    <HidSharp Include="HidSharp\HidDeviceLoader.cs" /> 
    <HidSharp Include="HidSharp\Platform\HidManager.cs" /> 
    <HidSharp Include="HidSharp\Platform\MacOS\MacHidManager.cs" /> 
    <HidSharp Include="HidSharp\Platform\MacOS\MacHidStream.cs" /> 
    <HidSharp Include="HidSharp\Platform\MacOS\MacHidDevice.cs" /> 
    <HidSharp Include="HidSharp\Platform\MacOS\NativeMethods.cs" /> 
    <HidSharp Include="HidSharp\Platform\Utf8Marshaler.cs" /> 
    <HidSharp Include="HidSharp\Platform\HidSelector.cs" /> 
    <HidSharp Include="HidSharp\Platform\Windows\WinHidManager.cs" /> 
    <HidSharp Include="HidSharp\Platform\Windows\WinHidDevice.cs" /> 
    <HidSharp Include="HidSharp\Platform\Windows\WinHidStream.cs" /> 
    <HidSharp Include="HidSharp\Platform\Windows\NativeMethods.cs" /> 
    <HidSharp Include="HidSharp\Platform\Unsupported\UnsupportedHidManager.cs" /> 
    <HidSharp Include="HidSharp\Platform\Linux\LinuxHidStream.cs" /> 
    <HidSharp Include="HidSharp\Platform\Linux\LinuxHidManager.cs" /> 
    <HidSharp Include="HidSharp\Platform\Linux\LinuxHidDevice.cs" /> 
    <HidSharp Include="HidSharp\Platform\Linux\NativeMethods.cs" />
  </ItemGroup>
  <Target Name="HIDSharpLibrary" Returns="HIDSharp.dll">
    <Csc Sources="@(HIDSharp)" AllowUnsafeBlocks="true" TargetType="library" OutputAssembly="HIDSharp.dll" 
        Platform="$(BuildPlatform)" DisabledWarnings="$(NoWarn)" />
  </Target>

</Project>
